<!DOCTYPE html> 
<html> 
    <head> 
    <title>Twitter Search</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
    
    <style>
    	/* Override some jQuery Mobile defaults */
    	
    	#tweet-list li a {
    		white-space: normal;
    		min-height: 48px;
    		padding-left: 60px;
    	}
    	
    	#tweet-list li img {
    		top: inherit;
    	}
    	
    	.tweet_text {
    		font-weight: normal;
    	}
    </style>
    
    <script src="../js/service.viafo.js"></script>
    <script src="./service.twitter.js"></script>
    <script src="./view.twitter.js"></script>
    <script>
		/*global $, SEARCH_RESULT, ViafoService, confirm */
		
		//
		// Change these values to match your Viafo settings
		//
		var VIAFO_SETTINGS = { 
		    'ENDPOINT' : 'https://vsg-live.appspot.com/client/1/', 
		    
		    'CLIENT_ID' : '9RSbot4xBsPLh83p0lYhMQemK51QVcLx', 
		    'CLIENT_SECRET' : 'BYXbkPGgKdZsO1YfVQ6BsuBnPyFE9mIh'
		};
		
		
		$(document).on('pageinit', function () {
			
			var CURRENT_TWEET = null;
			
			ViafoService.Init();
			
			$('#tweet-list').on('click', 'li a', function (event) {
				var me = $(this),
					id_str = me.attr('id'),
					item, i;
				
				for (i in SEARCH_RESULT.results) {
					if (SEARCH_RESULT.results.hasOwnProperty(i)) {
						item = SEARCH_RESULT.results[i];
						if (item.id_str == id_str) {
							break;
						}
						item = null;
					}
				}
				
				CURRENT_TWEET = item;
				
				// Allow propogation
				return true;
			});
			
			$('#reply').on('click', function (event) {
				if (CURRENT_TWEET) {
					ViafoService.CallTwitterReply(CURRENT_TWEET.id_str, 'Reply text', null, null, null, 
						function () {
							alert("Tweet sent");
						},
						function () {
							alert("Tweet failed");
						},
						function (service, callback) {
							if (confirm("You need to sign into " + service.display_name + " first, do it now?")) {
								callback();
							}
						});				
				}
				event.stopPropagation();
				return false;
			});
						
			$('#retweet').on('click', function (event) {
				if (CURRENT_TWEET) {
					ViafoService.CallTwitterRetweet(CURRENT_TWEET.id_str,
						function () {
							alert("Retweeted ok");
						},
						function () {
							alert("Retweet failed");
						},
						function (service, callback) {
							if (confirm("You need to sign into " + service.display_name + " first, do it now?")) {
								callback();
							}
						});				
				}
				event.stopPropagation();
				return false;
			});					
				
			$('#follow').on('click', function (event) {
				if (CURRENT_TWEET) {
					ViafoService.CallTwitterFollow(CURRENT_TWEET.from_user,
						function () {
							alert("Follow ok");
						},
						function () {
							alert("Follow failed");
						},
						function (service, callback) {
							if (confirm("You need to sign into " + service.display_name + " first, do it now?")) {
								callback();
							}
						});				
				}
				event.stopPropagation();
				return false;
			});
		});
		
    </script>
    </head>
<body> 

<div id="start" data-role="page">

    <div data-role="header" data-position="fixed">
        <h1>Twitter Search</h1>
    </div><!-- /header -->
    <div data-role="content">
    	<div>
	    	<form id="search-form">
	    		<fieldset class="ui-hide-label">
					<label for="search-box">Search:</label>
		        	<input type="search" name="search" id="search-box" value="" data-mini="true"/>
		        </fieldset>
		        <button type="submit" data-theme="a" data-inline="true" data-mini="true">Search</button>
	        </form>
        </div>
        <div>
			<ul id="tweet-list" data-role="listview" data-inset="true"></ul>
		</div>
    </div><!-- /content -->

</div><!-- /page -->


<div id="share" data-role="page">
    <div data-role="header">
        <h1>Share Options</h1>
    </div>
    <div data-role="content">
		<ul id="share-list" data-role="listview">
			<li id="reply">Reply</li>
			<li id="retweet">Retweet</li>
			<li id="follow">Follow User</li>
		</ul>
    </div>
</div>

</body>
</html>